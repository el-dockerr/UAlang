# =============================================================================
#  UA - Unified Assembler
#  Release Workflow — Build all platforms, generate checksums, upload to release
#
#  Triggered by: Creating/publishing a release in the GitHub UI
#                OR manually via workflow_dispatch
#
#  Release assets produced:
#    ua-linux-x86_64.tar.gz          Linux  x86-64
#    ua-macos-arm.tar.gz             macOS  Apple Silicon (ARM64)
#    ua-windows-x86_64.zip           Windows x86-64  (MinGW-w64)
#    ua-freebsd-x86_64.tar.gz        FreeBSD x86-64
#    checksums.sha256                SHA-256 hashes for all archives
#
#  Each archive contains:
#    ua  (or ua.exe)    — compiler binary
#    lib/               — standard library .ua files
# =============================================================================

name: Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build and release (e.g. v1.2.0)'
        required: true

permissions:
  contents: write

jobs:
  # ---------------------------------------------------------------------------
  #  Matrix job — Linux, macOS ARM, Windows
  # ---------------------------------------------------------------------------
  build:
    name: Build · ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:

          - name:    linux-x86_64
            os:      ubuntu-latest
            binary:  ua
            archive: ua-linux-x86_64.tar.gz

          - name:    macos-arm
            os:      macos-latest
            binary:  ua
            archive: ua-macos-arm.tar.gz

          - name:    windows-x86_64
            os:      windows-latest
            binary:  ua.exe
            archive: ua-windows-x86_64.zip

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---- Windows: install MinGW-w64 GCC via MSYS2 ----------------------
      - name: Set up MSYS2 (Windows)
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update:  true
          install: mingw-w64-x86_64-gcc

      # ---- Build: Linux / macOS ------------------------------------------
      - name: Build (Unix)
        if: runner.os != 'Windows'
        run: |
          gcc -std=c99 -Wall -Wextra -pedantic -o ua \
            src/main.c      src/lexer.c        src/parser.c      \
            src/codegen.c   src/precompiler.c                      \
            src/backend_8051.c   src/backend_x86_64.c             \
            src/backend_x86_32.c src/backend_arm.c                 \
            src/backend_arm64.c  src/backend_risc_v.c              \
            src/emitter_pe.c src/emitter_elf.c src/emitter_macho.c
          ./ua --version

      # ---- Build: Windows (MSYS2 / MinGW-w64) ----------------------------
      - name: Build (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          gcc -std=c99 -Wall -Wextra -pedantic -o ua.exe \
            src/main.c      src/lexer.c        src/parser.c      \
            src/codegen.c   src/precompiler.c                      \
            src/backend_8051.c   src/backend_x86_64.c             \
            src/backend_x86_32.c src/backend_arm.c                 \
            src/backend_arm64.c  src/backend_risc_v.c              \
            src/emitter_pe.c src/emitter_elf.c src/emitter_macho.c
          ./ua.exe --version

      # ---- Smoke-test ----------------------------------------------------
      - name: Smoke-test (Unix)
        if: runner.os != 'Windows'
        run: |
          printf 'LDI R0, 42\nHLT\n' > /tmp/smoke.ua
          ./ua /tmp/smoke.ua -arch x86 -o /tmp/smoke.bin

      - name: Smoke-test (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          printf 'LDI R0, 42\nHLT\n' > /tmp/smoke.ua
          ./ua.exe /tmp/smoke.ua -arch x86 -o /tmp/smoke.bin

      # ---- Package: tar.gz (Linux / macOS) -------------------------------
      - name: Package (Unix)
        if: runner.os != 'Windows'
        run: tar -czf ${{ matrix.archive }} ua lib/

      # ---- Package: zip (Windows) ----------------------------------------
      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: Compress-Archive -Path ua.exe, lib -DestinationPath ${{ matrix.archive }}

      # ---- Upload artifact -----------------------------------------------
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name:              ${{ matrix.name }}
          path:              ${{ matrix.archive }}
          if-no-files-found: error

  # ---------------------------------------------------------------------------
  #  Separate job — FreeBSD (via QEMU VM on an Ubuntu host)
  # ---------------------------------------------------------------------------
  build-freebsd:
    name: Build · freebsd-x86_64
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build & test on FreeBSD
        uses: vmactions/freebsd-vm@v1
        with:
          usesh: true
          prepare: pkg install -y gcc
          run: |
            set -e
            gcc -std=c99 -Wall -Wextra -pedantic -o ua \
              src/main.c      src/lexer.c        src/parser.c      \
              src/codegen.c   src/precompiler.c                      \
              src/backend_8051.c   src/backend_x86_64.c             \
              src/backend_x86_32.c src/backend_arm.c                 \
              src/backend_arm64.c  src/backend_risc_v.c              \
              src/emitter_pe.c src/emitter_elf.c src/emitter_macho.c
            ./ua --version
            printf 'LDI R0, 42\nHLT\n' > /tmp/smoke.ua
            ./ua /tmp/smoke.ua -arch x86 -o /tmp/smoke.bin

      # Package OUTSIDE the VM so the artifact path is reliable
      - name: Package FreeBSD archive
        run: tar -czf ua-freebsd-x86_64.tar.gz ua lib/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name:              freebsd-x86_64
          path:              ua-freebsd-x86_64.tar.gz
          if-no-files-found: error

  # ---------------------------------------------------------------------------
  #  Release job — collect all artifacts, generate checksums, upload to release
  #
  #  When triggered by `release: published`, assets are uploaded to the
  #  EXISTING release.  The release body written in the GitHub UI is preserved.
  #  When triggered by `workflow_dispatch`, a new release is created.
  # ---------------------------------------------------------------------------
  upload-assets:
    name: Upload Release Assets
    needs: [build, build-freebsd]
    runs-on: ubuntu-latest

    steps:
      # ---- Download every platform artifact into staging -----------------
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-staging/

      # ---- Flatten into dist/ --------------------------------------------
      - name: Flatten artifacts
        run: |
          mkdir -p dist/
          find release-staging/ -type f \( -name "*.tar.gz" -o -name "*.zip" \) \
               -exec mv {} dist/ \;
          echo "--- Release assets ---"
          ls -lh dist/

      # ---- Generate SHA-256 checksums ------------------------------------
      - name: Generate SHA-256 checksums
        working-directory: dist/
        run: |
          sha256sum * > checksums.sha256
          echo "--- Checksums ---"
          cat checksums.sha256

      # ---- Determine tag name --------------------------------------------
      - name: Set release tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "tag=${{ github.event.release.tag_name }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${{ github.event.inputs.tag }}" >> "$GITHUB_OUTPUT"
          fi

      # ---- Upload assets to the release ----------------------------------
      #  - On `release: published`: attaches files to the existing release
      #    without overwriting the release body or notes.
      #  - On `workflow_dispatch`: creates a new release for the given tag.
      - name: Upload assets to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name:     "UA Unified Assembler ${{ steps.version.outputs.tag }}"
          draft:    false
          prerelease: ${{ contains(steps.version.outputs.tag, '-') }}
          files: |
            dist/ua-linux-x86_64.tar.gz
            dist/ua-macos-arm.tar.gz
            dist/ua-windows-x86_64.zip
            dist/ua-freebsd-x86_64.tar.gz
            dist/checksums.sha256
